<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Report v21 | All Cabling Tech</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a; --panel-dark: #1e293b; --accent: #3b82f6; 
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; 
            --purple: #8b5cf6; --cogs: #64748b; --orange: #f97316;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; font-size: 14px; min-height: 100vh; overflow-y: auto; }
        .container { max-width: 1400px; margin: 0 auto; width: 100%; padding-bottom: 50px; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .logo-img { height: 60px; display: block; margin-left: auto; }
        .report-info h1 { font-size: 1.2rem; margin: 0; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .current-date { font-size: 1.1rem; color: var(--accent); font-weight: bold; margin-top: 5px; }

        /* GRID */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 20px; align-items: stretch; }
        @media(max-width: 1200px) { .main-grid { grid-template-columns: 1fr 1fr; } .right-col { grid-column: span 2; } }
        @media(max-width: 800px) { .main-grid { grid-template-columns: 1fr; } .right-col { grid-column: span 1; } }

        /* PANELS */
        .panel { background: var(--panel-dark); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; flex-direction: column; height: 100%; min-height: 600px; }
        .panel-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: var(--accent); border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .section-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 10px 0 5px 0; border-bottom: 1px dashed #334155; padding-bottom: 5px; }

        /* FORMS */
        .form-container { background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .form-container.active { display: block; animation: fadeIn 0.3s; }
        .form-container.editing { border-color: var(--warning); background: #334155; box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-add-trigger { width: 100%; padding: 12px; background: #334155; border: 2px dashed #475569; color: var(--text-muted); font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-add-trigger:hover { background: #3b82f620; border-color: var(--accent); color: var(--accent); }

        .form-control { width: 100%; background: #1e293b; border: 1px solid #475569; color: white; padding: 10px; border-radius: 6px; font-size: 0.95rem; }
        .row-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .row-inputs-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .row-cost-inputs { display: flex; gap: 10px; }

        /* TOOLTIPS */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #0f172a; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: 0.3s; border: 1px solid var(--accent); font-size: 0.8rem; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .info-icon { margin-left: 8px; color: var(--accent); cursor: help; }

        /* BUTTONS */
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #0f172a; } 
        .btn-orange { background: var(--orange); color: white; }
        .btn-cancel { background: #64748b; color: white; width: auto; flex: 1; }
        .btn-save { flex: 2; }
        .btn-icon { background: transparent; color: var(--text-muted); width: auto; padding: 5px; font-size: 1rem; border-radius: 4px; cursor: pointer; border: none; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: white; }

        /* LISTS */
        .scroll-list { overflow-y: auto; padding-right: 5px; flex-grow: 1; min-height: 100px; max-height: 50vh; }
        .list-card { background: #334155; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 4px solid var(--text-muted); display: flex; justify-content: space-between; align-items: center; }
        .list-card.expense { border-left-color: var(--warning); }
        .list-card.payroll { border-left-color: var(--accent); cursor: pointer; }
        .list-card.contractor { border-left-color: var(--orange); }
        .list-card.inactive { opacity: 0.5; background: #1e293b; border-left-color: #475569; }
        .card-val { font-family: monospace; font-weight: bold; color: var(--success); text-align: right; margin-right: 15px; }
        .day-badge { background: #334155; color: var(--text-muted); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; border: 1px solid #475569; }
        .panel-footer { margin-top: auto; padding-top: 15px; text-align: right; font-weight: bold; border-top: 1px solid #334155; flex-shrink: 0; }
        .right-scroll-container { overflow-y: auto; flex-grow: 1; padding-right: 5px; display: flex; flex-direction: column; max-height: 85vh; }

        /* KPI & CHART */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .kpi-card { background: #334155; padding: 10px; border-radius: 8px; text-align: center; border-bottom: 3px solid transparent; }
        .kpi-val { font-size: 1.1rem; font-weight: 800; margin: 5px 0; font-family: 'Consolas', monospace; }
        .kpi-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        
        .simulator-box { background: #1e293b; border: 1px solid #334155; padding: 15px; border-radius: 12px; flex-shrink: 0; }
        .slider-group { margin-bottom: 15px; }
        .sim-slider { width: 100%; margin: 8px 0; cursor: pointer; }
        .slider-label { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; }
        
        .projection-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .projection-table td { padding: 6px 8px; border-bottom: 1px solid #334155; }
        .projection-table .val { text-align: right; font-family: monospace; font-weight: bold; }
        .row-highlight { color: var(--success); font-size: 1.1rem; background: rgba(16, 185, 129, 0.1); }
        .row-total { color: var(--accent); font-size: 1.2rem; border-top: 2px solid #475569; font-weight: 800; }

        /* REAL COST TABLE */
        .cost-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        .cost-table th { text-align: left; color: var(--text-muted); border-bottom: 1px solid #475569; padding: 5px; font-size: 0.8rem; }
        .cost-table td { padding: 8px 5px; border-bottom: 1px solid #334155; vertical-align: middle; }
        .cost-table .val-col { text-align: right; font-family: monospace; }
        .cost-total-col { color: var(--warning); font-weight: bold; }
        .overhead-pill { background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; border: 1px solid #ef4444; margin-bottom: 10px; display:inline-block; }
        
        .prop-selector { transform: scale(1.3); cursor: pointer; accent-color: var(--success); }
        .badge-w2 { font-size:0.7rem; color:#3b82f6; border:1px solid #3b82f6; padding:0 3px; border-radius:3px; margin-left:5px; }
        .badge-1099 { font-size:0.7rem; color:var(--orange); border:1px solid var(--orange); padding:0 3px; border-radius:3px; margin-left:5px; }

        .toggle-container { display: flex; align-items: center; gap: 8px; margin-top: 5px; cursor: pointer; }
        .toggle-checkbox { transform: scale(1.2); cursor: pointer; }
        .toggle-label { font-size: 0.9rem; color: var(--text-main); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel-dark); width: 90%; max-width: 550px; border-radius: 12px; padding: 30px; border: 1px solid var(--accent); }
        .close-modal { float: right; font-size: 1.5rem; cursor: pointer; }

        #loadingBar { position:fixed; top:0; left:0; width:0%; height:4px; background:var(--accent); z-index:2000; transition:width 0.3s; }
        #syncStatus { font-size: 0.7rem; color: var(--success); margin-top: 5px; opacity: 0; transition: opacity 0.5s; text-align: right; display: block;}
        .report-only { display: none; }

        @media print {
            body { background: white; color: black; padding: 0; display: block; overflow: visible; }
            .container { max-width: 100%; margin: 0; }
            .header { margin-bottom: 10px; border-bottom: 2px solid #000; }
            .logo-text { display: block !important; color: #000; -webkit-text-fill-color: black; }
            .logo-img { display: block !important; }
            .no-print, button, .sim-slider, .form-container, .btn-add-trigger, .list-card button { display: none !important; }
            .report-only { display: block; margin-top: 20px; }
            .main-grid { display: block; }
            .left-col, .mid-col { display: none; } 
            .right-col { width: 100%; }
            .panel { box-shadow: none; border: none; padding: 0; margin: 0; display: block; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .kpi-card { border: 1px solid #ddd; background: #f9f9f9; color: black; }
            .kpi-val { color: black; }
            .simulator-box { border: 1px solid #ddd; background: white; padding: 0; }
            .projection-table td, .cost-table td { border-bottom: 1px solid #ddd; color: black; }
            .cost-table th { color: black; border-bottom: 1px solid #000; }
            .full-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
            .full-table th { background: #eee; text-align: left; padding: 5px; border: 1px solid #ccc; color:black; }
            .full-table td { border: 1px solid #ccc; padding: 5px; color:black; }
            canvas { max-height: 250px !important; }
        }
    </style>
</head>
<body>

<div id="loadingBar"></div>

<div class="container">
    <header class="header">
        <div class="report-info">
            <h1>Executive Report v21 | All Cabling Tech</h1>
            <div id="dateDisplay" class="current-date"></div>
            <span><i class="fas fa-cloud"></i> Online & Synchronized System</span>
        </div>
        <div class="logo-container">
            <img src="https://lh3.googleusercontent.com/d/1Zlo-Cf7zY-jANUusmo5iwCR8ADbPu6wx" alt="ACT Logo" class="logo-img" onerror="this.style.display='none'; document.getElementById('txtLogo').style.display='block';">
            <div id="txtLogo" class="logo-text">ALL CABLING TECH</div>
        </div>
    </header>

    <div class="main-grid">
        <div class="left-col">
            <div class="panel">
                <div class="panel-title"><i class="fas fa-users"></i> 1. Team Management</div>
                
                <div class="section-header">Employees (W-2)</div>
                <div class="form-wrapper">
                    <div id="btnShowEmp" class="btn-add-trigger" onclick="openAddForm('emp')"><i class="fas fa-plus-circle"></i> Add New Employee</div>
                    <div id="empFormBox" class="form-container no-print">
                        <input type="hidden" id="emp_edit_id">
                        <div class="input-group" style="margin-bottom: 10px;"><input type="text" id="emp_name" class="form-control" placeholder="Employee Name"></div>
                        <div class="row-inputs">
                            <div class="input-group"><select id="emp_state" class="form-control"><option value="FL">FL (0% Tax)</option><option value="NY">NY (~5% Tax)</option></select></div>
                            <select id="emp_filing" class="form-control"><option value="joint">Married</option><option value="single">Single</option></select>
                        </div>
                        <div class="row-inputs" style="margin-top: 10px;">
                            <div class="input-group"><input type="number" id="emp_net" class="form-control" placeholder="Net Salary"><div class="tooltip info-icon"><i class="fas fa-info-circle"></i><span class="tooltiptext">Monthly Amount in pocket.</span></div></div>
                            <input type="number" id="emp_deps" class="form-control" value="0" placeholder="Deps">
                        </div>
                        <div style="display:flex; gap:10px; margin-top: 10px;">
                            <button id="btnCancelEmp" onclick="cancelEmpEdit()" class="btn btn-cancel">Cancel</button>
                            <button id="btnSaveEmp" type="button" onclick="saveEmployee()" class="btn btn-primary btn-save">Save W-2</button>
                        </div>
                    </div>
                </div>
                <div id="employeeList" class="scroll-list" style="margin-bottom: 15px; border-bottom: 1px solid #334155;"><p style="color:#64748b; text-align:center; padding:10px;">Loading...</p></div>

                <div class="section-header">Contractors (1099)</div>
                <div class="form-wrapper">
                     <div id="btnShowCont" class="btn-add-trigger" onclick="openAddForm('cont')"><i class="fas fa-plus-circle"></i> Add New Contractor</div>
                    <div id="contFormBox" class="form-container no-print">
                        <input type="hidden" id="cont_edit_id">
                        <input type="text" id="cont_name" class="form-control" placeholder="Contractor Name" style="margin-bottom: 8px;">
                        <div class="row-inputs-3">
                            <input type="number" id="cont_rate" class="form-control" placeholder="Rate $">
                            <select id="cont_type" class="form-control"><option value="day">Day</option><option value="hour">Hour</option></select>
                            <input type="number" id="cont_qty" class="form-control" placeholder="Qty">
                        </div>
                        <div class="toggle-container">
                            <input type="checkbox" id="cont_active" class="toggle-checkbox" checked>
                            <label for="cont_active" class="toggle-label">Active this month</label>
                        </div>
                        <div style="display:flex; gap:10px; margin-top: 10px;">
                            <button id="btnCancelCont" onclick="cancelContEdit()" class="btn btn-cancel">Cancel</button>
                            <button id="btnSaveCont" type="button" onclick="saveContractor()" class="btn btn-orange btn-save">Save 1099</button>
                        </div>
                    </div>
                </div>
                <div id="contractorList" class="scroll-list"></div>
                <div class="panel-footer" style="color:var(--accent);">Total Team Cost: <span id="totalPayrollDisplay">...</span></div>
            </div>
        </div>

        <div class="mid-col">
            <div class="panel">
                <div class="panel-title"><i class="fas fa-building"></i> 2. Fixed Costs (Overhead)</div>
                <div class="form-wrapper">
                    <div id="btnShowCost" class="btn-add-trigger" onclick="openAddForm('cost')"><i class="fas fa-plus-circle"></i> Add New Cost</div>
                    <div id="costFormBox" class="form-container no-print">
                        <input type="hidden" id="cost_edit_id">
                        <p style="font-size:0.75rem; color:#94a3b8; margin-top:0;">Rent, Insurance, Software, Vehicles...</p>
                        <div class="row-cost-inputs">
                            <div class="input-group" style="flex:1"><input type="number" id="cost_day" class="form-control" placeholder="Day" min="1" max="31"></div>
                            <input type="text" id="cost_desc" class="form-control" placeholder="Description" style="flex:3">
                            <input type="number" id="cost_val" class="form-control" placeholder="$" style="flex:2">
                        </div>
                        <div style="display:flex; gap:10px; margin-top: 10px;">
                            <button id="btnCancelCost" onclick="cancelCostEdit()" class="btn btn-cancel">Cancel</button>
                            <button id="btnSaveCost" type="button" onclick="saveFixedCost()" class="btn btn-success btn-save">Save Cost</button>
                        </div>
                    </div>
                </div>
                <div id="fixedCostList" class="scroll-list"><p style="color:#64748b; text-align:center; padding:20px;">Loading...</p></div>
                <div class="panel-footer" style="color:var(--warning);">Total Overhead (Month): <span id="totalFixedDisplay">...</span></div>
            </div>
        </div>

        <div class="right-col">
            <div class="panel">
                <div class="panel-title"><i class="fas fa-chart-line"></i> 3. Simulator & Goals <span id="syncStatus">Saved <i class="fas fa-check"></i></span></div>
                <div class="right-scroll-container">
                    <div class="print-grid">
                        <div class="kpi-row">
                            <div class="kpi-card" style="border-bottom-color: var(--danger);"><div class="kpi-label">Total Fixed Cost</div><div class="kpi-val" id="totalOutflow">$0</div></div>
                            <div class="kpi-card" style="border-bottom-color: var(--cogs);"><div class="kpi-label">Break-even Point</div><div class="kpi-val" id="breakevenVal">$0</div></div>
                            <div class="kpi-card" style="border-bottom-color: var(--success);"><div class="kpi-label">Target Monthly Profit</div><div class="kpi-val" id="targetProfitMonthly">$0</div></div>
                        </div>
                        <div class="simulator-box">
                            <table class="projection-table">
                                <tr><td><i class="fas fa-arrow-down" style="color:var(--danger)"></i> Fixed Costs (Payroll+Overhead)</td><td class="val" id="simFixed">$0</td></tr>
                                <tr><td><i class="fas fa-arrow-up" style="color:var(--success)"></i> Target Monthly Profit</td><td class="val row-highlight" id="simProfit">$0</td></tr>
                                <tr style="border-top: 2px solid #475569; background:#0f172a;"><td style="padding:10px; font-weight:bold; color:white;">REQUIRED REVENUE</td><td class="val row-total" style="padding:10px;" id="simRevenue">$0</td></tr>
                            </table>
                            <div class="no-print" style="margin-top:10px;">
                                <div class="slider-group">
                                    <label class="slider-label" style="color:var(--success);"><span>Profit Goal</span> <span id="profitDisplay">...</span></label>
                                    <input type="range" id="profitSlider" class="sim-slider" min="0" max="500000" step="5000" onchange="saveSettingsToDB()" oninput="updateSimulation()">
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                    <div class="slider-group"><label class="slider-label" style="color:var(--accent); font-size:0.75rem;"><span>Markup</span> <span id="grossDisplay">...</span></label><input type="range" id="grossSlider" class="sim-slider" min="10" max="90" onchange="saveSettingsToDB()" oninput="updateSimulation()"></div>
                                    <div class="slider-group"><label class="slider-label" style="color:var(--purple); font-size:0.75rem;"><span>Comm.</span> <span id="commDisplay">...</span></label><input type="range" id="commSlider" class="sim-slider" min="0" max="20" onchange="saveSettingsToDB()" oninput="updateSimulation()"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="height:150px; margin-top:15px; page-break-inside: avoid; border-top: 1px solid #334155; padding-top:10px; flex-shrink: 0;">
                        <p style="text-align:center; font-size:0.75rem; color:var(--text-muted); margin:0;">Weekly Cash Flow</p>
                        <canvas id="cashFlowChart"></canvas>
                    </div>

                    <div style="margin-top: 20px; border-top: 2px solid #334155; padding-top: 15px;">
                        <h4 style="margin:0 0 10px 0; color:var(--orange); display:flex; justify-content:space-between;">
                            <span><i class="fas fa-tags"></i> Real Daily Cost (Pricing)</span>
                            <span style="font-size:0.8rem; color:#94a3b8; font-weight:normal;">Allocated Overhead</span>
                        </h4>
                        
                        <div style="text-align:center; margin-bottom:10px;">
                            <span class="overhead-pill">Overhead Allocation: <span id="overheadPerDayDisplay">...</span> / day</span>
                        </div>

                        <table class="cost-table">
                            <thead>
                                <tr>
                                    <th style="width:30px; text-align:center;"><i class="fas fa-check-square"></i></th>
                                    <th>Name</th>
                                    <th class="val-col">Base</th>
                                    <th class="val-col">+Overhead</th>
                                    <th class="val-col cost-total-col">REAL COST</th>
                                </tr>
                            </thead>
                            <tbody id="pricingTableBody"></tbody>
                        </table>

                        <div class="simulator-box" style="margin-top:15px; background:#1e293b; border:1px dashed #475569;">
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px;">PRECISE PROPOSAL CALCULATOR</div>
                            <p style="font-size:0.7rem; color: #94a3b8; margin:0 0 5px 0;">Select technicians above to calculate cost.</p>
                            <div style="margin-bottom:5px;">
                                <input type="number" id="propDays" class="form-control" placeholder="Number of Days" style="padding:5px;" oninput="calcProposal()">
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size:0.8rem;">Min Cost (Break-even):</span>
                                <span id="propBreakEven" style="color:var(--danger); font-weight:bold;">$0</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:3px;">
                                <span style="font-size:0.8rem;">Suggested Price:</span>
                                <span id="propSuggested" style="color:var(--success); font-weight:bold; font-size:1.1rem;">$0</span>
                            </div>
                        </div>
                    </div>

                    <div class="report-only">
                        <h3>Team Breakdown</h3>
                        <table class="full-table"><thead><tr><th>Name</th><th>Type</th><th>Details</th><th>Total Cost</th></tr></thead><tbody id="reportTableBody"></tbody></table>
                    </div>
                </div>
                <button onclick="window.print()" class="btn btn-primary no-print" style="margin-top:10px; flex-shrink:0;"><i class="fas fa-print"></i> Print Executive Report</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="empModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">Ã—</span>
        <h3 id="modalName">Details</h3>
        <table class="projection-table" style="font-size:1.1rem;">
            <tr><td>Net (In Pocket)</td><td class="val" id="modalNet" style="color:var(--success)">$0</td></tr>
            <tr><td>Taxes (Employee)</td><td class="val" id="modalTaxEmp" style="color:#ef4444">$0</td></tr>
            <tr style="border-top:1px dashed #666"><td><strong>Gross Salary</strong></td><td class="val" id="modalGross">$0</td></tr>
            <tr><td>Taxes (Employer)</td><td class="val" id="modalTaxComp">$0</td></tr>
            <tr style="background:#1e293b; border-top:2px solid var(--accent)"><td style="padding:15px"><strong>Total Company Cost</strong></td><td class="val" id="modalTotal" style="padding:15px; color:var(--accent)">$0</td></tr>
        </table>
        <div style="height:150px; margin-top:20px;"><canvas id="empChart"></canvas></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAXccSurpdFCwI8yBw6HX1DSEwZYdFX_Z0",
      authDomain: "allcablingtech-system.firebaseapp.com",
      projectId: "allcablingtech-system",
      storageBucket: "allcablingtech-system.firebasestorage.app",
      messagingSenderId: "395002580576",
      appId: "1:395002580576:web:877cb85f18a3c5f7b47d05"
    };

    let db;
    try { const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e) { console.error("Firebase Error", e); }

    let employees = [], contractors = [], fixedCosts = [], settings = { profit: 100000, gross: 50, comm: 5 };
    let cashFlowChart = null, modalChart = null;
    let globalOverheadPerDay = 0;
    
    // GLOBAL TOTALS (To prevent NaN issues)
    let g_totalPayroll = 0;
    let g_totalFixed = 0;

    window.saveEmployee = saveEmployee; window.editEmp = editEmp; window.cancelEmpEdit = cancelEmpEdit; window.removeEmp = removeEmp;
    window.saveContractor = saveContractor; window.editCont = editCont; window.cancelContEdit = cancelContEdit; window.removeCont = removeCont;
    window.saveFixedCost = saveFixedCost; window.editCost = editCost; window.cancelCostEdit = cancelCostEdit; window.removeCost = removeCost;
    window.saveSettingsToDB = saveSettingsToDB; window.updateSimulation = updateSimulation; window.openModal = openModal; window.closeModal = closeModal; window.openAddForm = openAddForm; window.calcProposal = calcProposal;
    
    function updateDate() { document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
    window.onload = updateDate;

    function openAddForm(type) { document.getElementById('btnShow' + type.charAt(0).toUpperCase() + type.slice(1)).style.display = 'none'; document.getElementById(type + 'FormBox').classList.add('active'); }

    if(db) {
        onSnapshot(doc(db, "act_settings", "global"), (doc) => { if (doc.exists()) { settings = doc.data(); document.getElementById('profitSlider').value = settings.profit; document.getElementById('grossSlider').value = settings.gross; document.getElementById('commSlider').value = settings.comm; updateSimulation(); flashSync(); } else { saveSettingsToDB(); } });
        onSnapshot(collection(db, "act_employees"), (s) => { employees = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
        onSnapshot(collection(db, "act_contractors"), (s) => { contractors = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
        onSnapshot(collection(db, "act_costs"), (s) => { fixedCosts = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); });
    }

    async function saveSettingsToDB() { await setDoc(doc(db, "act_settings", "global"), { profit: parseInt(document.getElementById('profitSlider').value), gross: parseInt(document.getElementById('grossSlider').value), comm: parseInt(document.getElementById('commSlider').value) }); updateSimulation(); }
    function flashSync() { const el = document.getElementById('syncStatus'); el.style.opacity = '1'; setTimeout(() => el.style.opacity = '0', 2000); }

    function calculatePayroll(net, state, filing, deps) {
        let effectiveRate = (filing === 'joint') ? 0.08 : 0.14; effectiveRate -= (deps * 0.015); if (effectiveRate < 0.02) effectiveRate = 0.02; if (state === 'NY') effectiveRate += 0.045; 
        const gross = net / (1 - (effectiveRate + 0.0765)); const totalCost = gross + (gross * 0.0765) + (gross * 0.008);
        return { net, gross, empTax: gross * (effectiveRate + 0.0765), compTax: (gross * 0.0765) + (gross * 0.008), totalCost };
    }

    // CRUD
    async function saveEmployee() { const id = document.getElementById('emp_edit_id').value; const data = { name: document.getElementById('emp_name').value, state: document.getElementById('emp_state').value, filing: document.getElementById('emp_filing').value, net: parseFloat(document.getElementById('emp_net').value)||0, deps: parseInt(document.getElementById('emp_deps').value)||0 }; if(id) await updateDoc(doc(db,"act_employees",id),data); else await addDoc(collection(db,"act_employees"),data); cancelEmpEdit(); }
    function editEmp(id) { const e = employees.find(x=>x.id===id); document.getElementById('emp_edit_id').value=e.id; document.getElementById('emp_name').value=e.name; document.getElementById('emp_state').value=e.state; document.getElementById('emp_filing').value=e.filing; document.getElementById('emp_net').value=e.net; document.getElementById('emp_deps').value=e.deps; openAddForm('emp'); document.getElementById('empFormBox').classList.add('editing'); document.getElementById('btnSaveEmp').innerText="Save Changes"; document.getElementById('btnSaveEmp').className="btn btn-warning btn-save"; }
    function cancelEmpEdit() { document.getElementById('emp_edit_id').value=""; document.getElementById('empFormBox').classList.remove('editing','active'); document.getElementById('btnSaveEmp').innerText="Save W-2"; document.getElementById('btnSaveEmp').className="btn btn-primary btn-save"; document.getElementById('btnShowEmp').style.display='flex'; document.getElementById('emp_name').value=''; document.getElementById('emp_net').value=''; }
    async function removeEmp(id) { if(confirm("Remove?")) await deleteDoc(doc(db,"act_employees",id)); }

    async function saveContractor() { const id = document.getElementById('cont_edit_id').value; const data = { name: document.getElementById('cont_name').value, rate: parseFloat(document.getElementById('cont_rate').value)||0, type: document.getElementById('cont_type').value, qty: parseFloat(document.getElementById('cont_qty').value)||0, active: document.getElementById('cont_active').checked }; if(id) await updateDoc(doc(db,"act_contractors",id),data); else await addDoc(collection(db,"act_contractors"),data); cancelContEdit(); }
    function editCont(id) { const c = contractors.find(x=>x.id===id); document.getElementById('cont_edit_id').value=c.id; document.getElementById('cont_name').value=c.name; document.getElementById('cont_rate').value=c.rate; document.getElementById('cont_type').value=c.type; document.getElementById('cont_qty').value=c.qty; document.getElementById('cont_active').checked=c.active; openAddForm('cont'); document.getElementById('contFormBox').classList.add('editing'); document.getElementById('btnSaveCont').innerText="Save Changes"; document.getElementById('btnSaveCont').className="btn btn-warning btn-save"; }
    function cancelContEdit() { document.getElementById('cont_edit_id').value=""; document.getElementById('contFormBox').classList.remove('editing','active'); document.getElementById('btnSaveCont').innerText="Save 1099"; document.getElementById('btnSaveCont').className="btn btn-orange btn-save"; document.getElementById('btnShowCont').style.display='flex'; document.getElementById('cont_name').value=''; document.getElementById('cont_rate').value=''; document.getElementById('cont_qty').value=''; }
    async function removeCont(id) { if(confirm("Remove?")) await deleteDoc(doc(db,"act_contractors",id)); }

    async function saveFixedCost() { const id = document.getElementById('cost_edit_id').value; const data = { desc: document.getElementById('cost_desc').value, val: parseFloat(document.getElementById('cost_val').value)||0, day: parseInt(document.getElementById('cost_day').value)||1 }; if(id) await updateDoc(doc(db,"act_costs",id),data); else await addDoc(collection(db,"act_costs"),data); cancelCostEdit(); }
    function editCost(id) { const c = fixedCosts.find(x=>x.id===id); document.getElementById('cost_edit_id').value=c.id; document.getElementById('cost_desc').value=c.desc; document.getElementById('cost_val').value=c.val; document.getElementById('cost_day').value=c.day||1; openAddForm('cost'); document.getElementById('costFormBox').classList.add('editing'); document.getElementById('btnSaveCost').innerText="Save Changes"; document.getElementById('btnSaveCost').className="btn btn-warning btn-save"; }
    function cancelCostEdit() { document.getElementById('cost_edit_id').value=""; document.getElementById('costFormBox').classList.remove('editing','active'); document.getElementById('btnSaveCost').innerText="Save Cost"; document.getElementById('btnSaveCost').className="btn btn-success btn-save"; document.getElementById('btnShowCost').style.display='flex'; document.getElementById('cost_desc').value=''; document.getElementById('cost_val').value=''; document.getElementById('cost_day').value=''; }
    async function removeCost(id) { if(confirm("Remove?")) await deleteDoc(doc(db,"act_costs",id)); }

    function renderAll() {
        try {
            const empList = document.getElementById('employeeList'); const contList = document.getElementById('contractorList'); const reportBody = document.getElementById('reportTableBody');
            const pricingBody = document.getElementById('pricingTableBody');
            
            empList.innerHTML = ''; contList.innerHTML = ''; reportBody.innerHTML = ''; pricingBody.innerHTML = '';
            
            // RESET TOTALS
            g_totalPayroll = 0;
            g_totalFixed = 0;
            let activeHeadcount = 0;

            if(fixedCosts && fixedCosts.length > 0) {
                // Safe reduce avoiding NaN
                g_totalFixed = fixedCosts.reduce((sum, c) => sum + (parseFloat(c.val)||0), 0);
            }

            const activeW2 = employees.length; 
            const active1099 = contractors.filter(c => c.active).length;
            activeHeadcount = activeW2 + active1099;
            const totalCapacityDays = activeHeadcount * 20; 
            globalOverheadPerDay = totalCapacityDays > 0 ? g_totalFixed / totalCapacityDays : 0;
            document.getElementById('overheadPerDayDisplay').innerText = formatMoney(globalOverheadPerDay);

            employees.forEach(e => {
                const f = calculatePayroll(e.net, e.state, e.filing, e.deps); 
                g_totalPayroll += (f.totalCost || 0); // Safety
                empList.innerHTML += `<div class="list-card payroll"><div class="card-info" onclick="openModal('${e.id}')"><div class="card-title">${e.name} <span class="badge-w2">W2</span></div><div class="card-sub">Net: ${formatMoney(e.net)} | Cost: ${formatMoney(f.totalCost)}</div></div><div><button class="btn-icon btn-edit-icon" onclick="editEmp('${e.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-icon btn-del-icon" onclick="removeEmp('${e.id}')"><i class="fas fa-trash"></i></button></div></div>`;
                const dailyBase = f.totalCost / 20; 
                const realCost = dailyBase + globalOverheadPerDay;
                pricingBody.innerHTML += `<tr><td style="text-align:center;"><input type="checkbox" class="prop-selector" data-cost="${realCost}" onchange="calcProposal()"></td><td>${e.name} <span class="badge-w2">W2</span></td><td class="val-col">${formatMoney(dailyBase)}</td><td class="val-col" style="color:#94a3b8;">+${formatMoney(globalOverheadPerDay)}</td><td class="val-col cost-total-col">${formatMoney(realCost)}</td></tr>`;
            });

            contractors.forEach(c => {
                const cost = (parseFloat(c.rate)||0) * (parseFloat(c.qty)||0); 
                if(c.active) g_totalPayroll += cost;
                const typeLabel = c.type === 'day' ? 'd' : 'h'; const statusClass = c.active ? 'contractor' : 'inactive'; const icon = c.active ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : '<i class="fas fa-ban" style="color:gray"></i>';
                contList.innerHTML += `<div class="list-card ${statusClass}"><div class="card-info" onclick="editCont('${c.id}')"><div class="card-title">${c.name} ${icon} <span class="badge-1099">1099</span></div><div class="card-sub">${c.qty}${typeLabel} @ ${formatMoney(c.rate)}</div></div><div class="card-val">${c.active ? formatMoney(cost) : '<span style="text-decoration:line-through; color:gray">'+formatMoney(cost)+'</span>'}</div><div><button class="btn-icon btn-edit-icon" onclick="editCont('${c.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-icon btn-del-icon" onclick="removeCont('${c.id}')"><i class="fas fa-trash"></i></button></div></div>`;
                if(c.active) {
                    let dailyBase = c.type === 'hour' ? c.rate * 8 : c.rate;
                    const realCost = dailyBase + globalOverheadPerDay;
                    pricingBody.innerHTML += `<tr><td style="text-align:center;"><input type="checkbox" class="prop-selector" data-cost="${realCost}" onchange="calcProposal()"></td><td>${c.name} <span class="badge-1099">1099</span></td><td class="val-col">${formatMoney(dailyBase)}</td><td class="val-col" style="color:#94a3b8;">+${formatMoney(globalOverheadPerDay)}</td><td class="val-col cost-total-col">${formatMoney(realCost)}</td></tr>`;
                }
            });
            
            document.getElementById('totalPayrollDisplay').innerText = formatMoney(g_totalPayroll);

            const costList = document.getElementById('fixedCostList');
            costList.innerHTML = '';
            let weeklyOverhead = [0,0,0,0];
            if(fixedCosts && fixedCosts.length > 0) {
                fixedCosts.sort((a,b) => (a.day || 32) - (b.day || 32));
                fixedCosts.forEach(c => {
                    const d = parseInt(c.day) || 1;
                    const v = parseFloat(c.val) || 0;
                    if(d <= 7) weeklyOverhead[0] += v; else if(d <= 15) weeklyOverhead[1] += v; else if(d <= 23) weeklyOverhead[2] += v; else weeklyOverhead[3] += v;
                    costList.innerHTML += `<div class="list-card expense"><div class="card-info"><div class="card-title"><span class="day-badge">${d}</span> ${c.desc}</div></div><div class="card-val">${formatMoney(v)}</div><div><button class="btn-icon btn-edit-icon" onclick="editCost('${c.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-icon btn-del-icon" onclick="removeCost('${c.id}')"><i class="fas fa-trash"></i></button></div></div>`;
                });
            }
            document.getElementById('totalFixedDisplay').innerText = formatMoney(g_totalFixed);
            
            let weeklyPayroll = [0,0,0,0]; const halfPayroll = g_totalPayroll / 2;
            weeklyPayroll[0] = halfPayroll; weeklyPayroll[1] = halfPayroll;

            updateSimulation(); 
            updateCashFlowChart(weeklyOverhead, weeklyPayroll);

        } catch(err) {
            console.error(err);
        }
    }

    function calcProposal() {
        const days = parseFloat(document.getElementById('propDays').value) || 1;
        const checkboxes = document.querySelectorAll('.prop-selector:checked');
        const grossMargin = parseInt(document.getElementById('grossSlider').value) || 50;
        let totalDailyCost = 0;
        checkboxes.forEach(cb => { totalDailyCost += parseFloat(cb.dataset.cost); });
        const totalBaseCost = totalDailyCost * days;
        document.getElementById('propBreakEven').innerText = formatMoney(totalBaseCost);
        let denominator = (1 - (grossMargin/100)); if (denominator <= 0.05) denominator = 0.05;
        const suggestedPrice = totalBaseCost / denominator;
        document.getElementById('propSuggested').innerText = formatMoney(suggestedPrice);
    }

    function updateCashFlowChart(overheadData, payrollData) {
        try {
            const ctx = document.getElementById('cashFlowChart').getContext('2d'); if(cashFlowChart) cashFlowChart.destroy();
            cashFlowChart = new Chart(ctx, {
                type: 'bar', data: { labels: ['W1 (1-7)', 'W2 (8-15)', 'W3 (16-23)', 'W4 (24-31)'], datasets: [ { label: 'Payroll', data: payrollData, backgroundColor: '#10b981', borderRadius: 4, stack: '0' }, { label: 'Overhead', data: overheadData, backgroundColor: '#3b82f6', borderRadius: 4, stack: '0' } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' }, stacked: true }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font:{size:10} }, stacked: true } }, plugins: { legend: { display: true, labels: { color: '#94a3b8', boxWidth: 10 } } } }
            });
        } catch(e) { console.log("Chart Error", e); }
    }

    function updateSimulation() {
        // USE GLOBAL VARS, DO NOT PARSE DOM
        const payroll = g_totalPayroll || 0;
        const fixed = g_totalFixed || 0;

        const targetAnnualProfit = parseInt(document.getElementById('profitSlider').value);
        const grossMargin = parseInt(document.getElementById('grossSlider').value);
        const commPct = parseInt(document.getElementById('commSlider').value);
        
        document.getElementById('profitDisplay').innerText = '$' + (targetAnnualProfit/1000).toFixed(0) + 'k/yr';
        document.getElementById('grossDisplay').innerText = grossMargin + '%';
        document.getElementById('commDisplay').innerText = commPct + '%';
        document.getElementById('commPctText').innerText = commPct + '%';

        const totalFixedMonthly = payroll + fixed;
        const targetMonthlyProfit = targetAnnualProfit / 12;
        const denominator = (grossMargin / 100) - (commPct / 100);
        let revenue = 0; if(denominator > 0) revenue = (totalFixedMonthly + targetMonthlyProfit) / denominator;
        
        document.getElementById('simFixed').innerText = formatMoney(totalFixedMonthly);
        document.getElementById('simProfit').innerText = formatMoney(targetMonthlyProfit);
        document.getElementById('simRevenue').innerText = formatMoney(revenue);
        document.getElementById('totalOutflow').innerText = formatMoney(totalFixedMonthly);
        document.getElementById('breakevenVal').innerText = formatMoney(denominator > 0 ? totalFixedMonthly / denominator : 0);
        document.getElementById('targetProfitMonthly').innerText = formatMoney(targetMonthlyProfit);
        
        calcProposal(); 
    }

    function formatMoney(n) { return '$' + (n || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

    function openModal(id) {
        const emp = employees.find(e => e.id === id); if(!emp) return;
        const f = calculatePayroll(emp.net, emp.state, emp.filing, emp.deps);
        document.getElementById('modalName').innerText = emp.name;
        document.getElementById('modalNet').innerText = formatMoney(f.net);
        document.getElementById('modalTaxEmp').innerText = formatMoney(f.empTax);
        document.getElementById('modalGross').innerText = formatMoney(f.gross);
        document.getElementById('modalTaxComp').innerText = formatMoney(f.compTax);
        document.getElementById('modalTotal').innerText = formatMoney(f.totalCost);
        document.getElementById('empModal').style.display = 'flex';
        const ctx = document.getElementById('empChart').getContext('2d'); if(modalChart) modalChart.destroy();
        modalChart = new Chart(ctx, { type: 'bar', data: { labels: ['Net', 'Taxes', 'Total'], datasets: [{ data: [f.net, f.empTax+f.compTax, f.totalCost], backgroundColor: ['#10b981', '#f59e0b', '#3b82f6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales:{x:{ticks:{color:'#94a3b8'}}, y:{ticks:{color:'#94a3b8'}}} } });
    }
    
    function closeModal() { document.getElementById('empModal').style.display = 'none'; }
</script>
</body>
</html>