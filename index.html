<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Report v33 | All Cabling Tech</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f172a; --panel-dark: #1e293b; --accent: #3b82f6; --text-main: #f8fafc; --text-muted: #94a3b8; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --purple: #8b5cf6; --orange: #f97316; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; font-size: 14px; min-height: 100vh; overflow-y: auto; }
        .admin-btn { display: none; }
        
        /* VISUALIZAÇÃO APENAS (LEONARDO) */
        body.view-only .btn-add-trigger, body.view-only .btn-icon, body.view-only .form-container { display: none !important; }
        body.view-only input, body.view-only select { pointer-events: none; border: none; background: transparent; color: #cbd5e1; }
        body.view-only .sim-slider { pointer-events: auto; }

        .container { max-width: 1400px; margin: 0 auto; width: 100%; padding-bottom: 50px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .logo-img { height: 50px; display: block; margin-left: auto; }
        
        /* LAYOUT PADRÃO (TELA) */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 20px; align-items: start; }
        @media(max-width: 1200px) { .main-grid { grid-template-columns: 1fr 1fr; } .right-col { grid-column: span 2; } .panel { height: auto !important; min-height: 500px; } }
        @media(max-width: 800px) { .main-grid { grid-template-columns: 1fr; } .right-col { grid-column: span 1; } }
        
        .panel { background: var(--panel-dark); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; flex-direction: column; border: 1px solid #334155; position: relative; }
        .panel-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--accent); border-bottom: 1px solid #334155; padding-bottom: 10px; flex-shrink: 0; }
        
        .fill-space { flex: 1; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; min-height: 0; }
        .fill-space::-webkit-scrollbar { width: 6px; } .fill-space::-webkit-scrollbar-track { background: #1e293b; } .fill-space::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .list-card { background: #334155; border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 4px solid #94a3b8; display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-shrink: 0; }
        .list-card > div:first-child { flex: 1; min-width: 0; line-height: 1.3; } .list-card > div:last-child { flex-shrink: 0; white-space: nowrap; display: flex; align-items: center; }
        .list-card.expense { border-left-color: var(--warning); } .list-card.payroll { border-left-color: var(--accent); } .list-card.contractor { border-left-color: var(--orange); }
        .card-val { font-family: monospace; font-weight: bold; color: var(--success); margin-right: 10px; font-size: 0.95rem; }
        
        .form-container { background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; flex-shrink: 0; }
        .form-container.active { display: block; }
        .btn-add-trigger { width: 100%; padding: 10px; background: #334155; border: 2px dashed #475569; color: var(--text-muted); font-weight: bold; border-radius: 8px; cursor: pointer; margin-bottom: 10px; text-align: center; flex-shrink: 0; font-size: 0.8rem; }
        .form-control { width: 100%; background: #1e293b; border: 1px solid #475569; color: white; padding: 8px; border-radius: 6px; margin-bottom: 5px; }
        .btn { padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; border: none; color: white; margin-top: 5px; }
        .btn-primary { background: var(--accent); } .btn-success { background: var(--success); } .btn-warning { background: var(--warning); color: #0f172a; } .btn-orange { background: var(--orange); } 
        
        .panel-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #334; text-align: right; font-weight: bold; flex-shrink: 0; background: var(--panel-dark); }

        .kpi-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: #334155; padding: 10px; border-radius: 8px; text-align: center; border-bottom: 3px solid transparent; }
        .kpi-val { font-size: 1.1rem; font-weight: 800; font-family: monospace; }
        .simulator-box { background: #1e293b; border: 1px solid #334155; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .sim-slider { width: 100%; margin: 10px 0; }
        .projection-table { width: 100%; margin-top: 10px; font-size: 0.9rem; border-collapse: collapse; }
        .projection-table td { padding: 5px; border-bottom: 1px solid #334155; }
        .cost-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        .cost-table td { padding: 8px 5px; border-bottom: 1px solid #334155; text-align: left; vertical-align: middle; }
        .cost-table th { padding: 5px; border-bottom: 1px solid #334155; text-align: left; }
        .val-col { text-align: right; font-family: monospace; }
        .row-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-icon { background: transparent; color: #94a3b8; border: none; cursor: pointer; font-size: 1rem; margin-left: 8px; transition: color 0.2s; } .btn-icon:hover { color: #fff; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--panel-dark); width: 90%; max-width: 400px; padding: 0; border-radius: 12px; border: 1px solid var(--accent); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); overflow: hidden; animation: popUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .pop-header { background: #334155; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #475569; }
        .pop-title h3 { margin: 0; color: white; font-size: 1.1rem; }
        .pop-body { padding: 20px; }
        
        .login-input { background: #0f172a; border: 1px solid #475569; padding: 15px; color: white; width: 100%; border-radius: 8px; margin-bottom: 15px; font-size: 1.1rem; text-align: center; }
        .login-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; font-weight: bold; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: 0.2s; } .login-btn:hover { background: #2563eb; }
        .log-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; margin-top: 10px; } .log-table td { border-bottom: 1px solid #334; padding: 5px; color: #94a3b8; }

        /* --- ESTILOS PROFISSIONAIS DE IMPRESSÃO (PÁGINAS) --- */
        @media print { 
            @page { size: portrait; margin: 1cm; }
            
            /* Reset Geral para Branco e Preto */
            body { background-color: #ffffff !important; color: #000000 !important; overflow: visible !important; height: auto !important; padding: 0 !important; }
            .container { max-width: 100% !important; padding: 0 !important; }
            
            /* Esconde elementos de tela */
            .no-print, .btn-add-trigger, .btn, .btn-icon, .modal-overlay, .admin-btn { display: none !important; }
            
            /* Ajuste do Grid para Bloco (Um embaixo do outro) */
            .main-grid { display: block !important; }
            
            /* Paineis - Fundo Branco e Borda Simples */
            .panel { 
                background-color: #ffffff !important; 
                border: 1px solid #ddd !important; 
                box-shadow: none !important; 
                color: #000 !important;
                margin-bottom: 20px;
                break-inside: avoid; /* Tenta não quebrar o painel no meio */
                height: auto !important; /* Remove altura fixa */
                overflow: visible !important;
            }
            
            /* Títulos */
            .panel-title { color: #2563eb !important; border-bottom: 2px solid #eee !important; }
            .section-header { color: #666 !important; }
            
            /* Cards da Lista */
            .list-card { 
                background-color: #f8f9fa !important; 
                border: 1px solid #eee !important; 
                color: #000 !important; 
                break-inside: avoid;
            }
            .list-card.payroll { border-left: 4px solid #10b981 !important; }
            .list-card.expense { border-left: 4px solid #f59e0b !important; }
            .list-card.contractor { border-left: 4px solid #f97316 !important; }
            
            /* Textos Claros viram Escuros */
            .card-val { color: #000 !important; }
            .text-muted { color: #666 !important; }
            input { color: #000 !important; }
            
            /* Tabelas e Rodapés */
            .panel-footer { background-color: #fff !important; border-top: 2px solid #eee !important; color: #000 !important; }
            .projection-table td, .cost-table td { border-bottom: 1px solid #eee !important; color: #000 !important; }
            .kpi-card { background-color: #f8f9fa !important; border: 1px solid #ddd !important; }
            
            /* --- ESTRATÉGIA DE PÁGINAS --- */
            
            /* PÁGINA 1: Coluna Esquerda e Meio */
            .left-col, .mid-col {
                width: 100% !important;
                page-break-inside: avoid;
            }
            
            /* PÁGINA 2: Coluna Direita (Simulador) */
            .right-col {
                width: 100% !important;
                page-break-before: always; /* Força quebra de página antes desta coluna */
                margin-top: 0 !important;
            }
            
            /* Remove Scrollbars */
            .fill-space, .scroll-list { overflow: visible !important; height: auto !important; }
            ::-webkit-scrollbar { display: none; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="loginModal">
    <div class="modal-content">
        <div class="pop-header" style="justify-content:center;"><h3>ACT SYSTEM ACCESS</h3></div>
        <div class="pop-body" style="text-align:center;">
            <p style="color:#94a3b8; margin-bottom:20px;">Please identify yourself</p>
            <select id="loginUser" class="login-input">
                <option value="dante">Dante Frota (CEO)</option>
                <option value="leonardo">Leonardo (COO)</option>
            </select>
            <input type="password" id="loginPass" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="attemptLogin()">ENTER SYSTEM</button>
            <p id="loginError" style="color:var(--danger); margin-top:10px; display:none;">Invalid Password</p>
        </div>
    </div>
</div>

<div class="modal-overlay" id="adminModal" style="display:none;">
    <div class="modal-content" style="max-width:600px;">
        <div class="pop-header"><h3>ADMIN PANEL</h3><span style="cursor:pointer; font-size:1.5rem;" onclick="document.getElementById('adminModal').style.display='none'">×</span></div>
        <div class="pop-body">
            <h4 style="color:var(--accent); margin-top:0;">Access Logs</h4>
            <div style="max-height:200px; overflow-y:auto; background:#0f172a; padding:10px; border-radius:8px;"><table class="log-table" id="logTable"></table></div>
            <h4 style="color:var(--warning); margin-top:20px;">Security Settings</h4>
            <div class="row-inputs">
                <input type="text" id="newPassLeo" class="form-control" placeholder="New Pass (Leonardo)">
                <input type="text" id="newPassDante" class="form-control" placeholder="New Pass (Dante)">
            </div>
            <button class="btn btn-primary" onclick="updatePasswords()">Update Credentials</button>
        </div>
    </div>
</div>

<div class="container">
    <header class="header">
        <div><h1 style="font-size:1.2rem; color:#94a3b8; margin:0;">EXECUTIVE REPORT v33</h1><div id="dateDisplay" style="color:var(--accent); font-weight:bold; font-size:1.1rem;"></div></div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn no-print admin-btn" onclick="document.getElementById('adminModal').style.display='flex'" style="background:#475569; width:auto; padding:8px 15px;"><i class="fas fa-user-shield"></i> Admin</button>
            <button class="btn no-print" onclick="window.print()" style="background:#334155; width:auto; padding:8px 15px;"><i class="fas fa-print"></i> PDF</button>
            <img src="https://lh3.googleusercontent.com/d/1Zlo-Cf7zY-jANUusmo5iwCR8ADbPu6wx" alt="ACT" class="logo-img" onerror="this.style.display='none'">
        </div>
    </header>

    <div class="main-grid">
        <div class="left-col">
            <div class="panel" id="panel1">
                <div class="panel-title">1. Team Management</div>
                <div class="fill-space">
                    <div class="section-header">EMPLOYEES (W-2)</div>
                    <div class="btn-add-trigger no-print" onclick="toggle('empForm')">+ Add Employee</div>
                    <div id="empForm" class="form-container">
                        <input type="hidden" id="emp_id"><input type="text" id="emp_name" class="form-control" placeholder="Name">
                        <div class="row-inputs"><select id="emp_state" class="form-control"><option value="FL">FL</option><option value="NY">NY</option></select><input type="number" id="emp_net" class="form-control" placeholder="Net Salary"></div>
                        <button class="btn btn-primary" onclick="saveEmployee()">Save W-2</button>
                    </div>
                    <div id="listEmp">Loading...</div>
                    <div class="section-header" style="margin-top:20px;">CONTRACTORS (1099)</div>
                    <div class="btn-add-trigger no-print" onclick="toggle('contForm')">+ Add Contractor</div>
                    <div id="contForm" class="form-container">
                        <input type="hidden" id="cont_id"><input type="text" id="cont_name" class="form-control" placeholder="Name">
                        <div class="row-inputs"><input type="number" id="cont_rate" class="form-control" placeholder="Rate $"><input type="number" id="cont_qty" class="form-control" placeholder="Qty"></div>
                        <select id="cont_type" class="form-control"><option value="day">Day</option><option value="hour">Hour</option></select>
                        <label style="display:block; margin-top:5px;"><input type="checkbox" id="cont_active" checked> Active this month</label>
                        <button class="btn btn-orange" onclick="saveContractor()">Save 1099</button>
                    </div>
                    <div id="listCont"></div>
                </div> 
                <div class="panel-footer" style="color:var(--accent);">Total Payroll: <span id="dispPayroll">$0.00</span></div>
            </div>
        </div>

        <div class="mid-col">
            <div class="panel" id="panel2">
                <div class="panel-title">2. Fixed Costs (Overhead)</div>
                <div class="fill-space">
                    <div style="height:140px; width:100%; display:flex; justify-content:center; margin-bottom:15px; border-bottom:1px dashed #334; padding-bottom:10px;"><canvas id="overheadChart"></canvas></div>
                    <div class="btn-add-trigger no-print" onclick="toggle('costForm')">+ Add Cost</div>
                    <div id="costForm" class="form-container">
                        <input type="hidden" id="cost_id"><div class="row-inputs"><input type="number" id="cost_day" class="form-control" placeholder="Day" style="flex:1"><input type="number" id="cost_val" class="form-control" placeholder="Value $" style="flex:2"></div>
                        <input type="text" id="cost_desc" class="form-control" placeholder="Description"><button class="btn btn-success" onclick="saveCost()">Save Cost</button>
                    </div>
                    <div id="listCost">Loading...</div>
                </div> 
                <div class="panel-footer" style="color:var(--warning);">Total Overhead: <span id="dispFixed">$0.00</span></div>
            </div>
        </div>

        <div class="right-col">
            <div class="panel" id="panel3" style="height: auto;">
                <div class="panel-title">3. Simulator & Goals</div>
                <div class="kpi-row">
                    <div class="kpi-card" style="border-bottom-color:var(--danger);"><div style="font-size:0.7rem">TOTAL OUTFLOW</div><div class="kpi-val" id="kpiTotal">$0</div></div>
                    <div class="kpi-card" style="border-bottom-color:var(--warning);"><div style="font-size:0.7rem">BREAK-EVEN</div><div class="kpi-val" id="kpiBreak">$0</div></div>
                    <div class="kpi-card" style="border-bottom-color:var(--success);"><div style="font-size:0.7rem">TARGET PROFIT</div><div class="kpi-val" id="kpiProfit">$0</div></div>
                </div>
                <div class="simulator-box">
                    <div class="no-print">
                        <label>Profit Goal: <span id="lblProfit" style="color:var(--success)">...</span></label><input type="range" id="slProfit" class="sim-slider" min="0" max="500000" step="5000" value="100000" oninput="runSim()">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div><label>Markup: <span id="lblGross" style="color:var(--accent)">...</span></label><input type="range" id="slGross" class="sim-slider" min="10" max="90" value="45" oninput="runSim()"></div>
                            <div><label>Comm: <span id="lblComm" style="color:var(--purple)">...</span></label><input type="range" id="slComm" class="sim-slider" min="0" max="20" value="5" oninput="runSim()"></div>
                        </div>
                    </div>
                    <table class="projection-table">
                        <tr><td>Required Revenue</td><td class="val" id="valRevenue" style="color:var(--accent); font-size:1.1rem">$0</td></tr>
                        <tr><td><small>Fixed Costs</small></td><td class="val" id="valFixed">$0</td></tr>
                        <tr><td><small>COGS (Materials)</small></td><td class="val" id="valCOGS" style="color:var(--cogs)">$0</td></tr>
                    </table>
                </div>
                <div style="height:150px; margin-top:20px; position: relative;"><canvas id="cashChart" style="cursor: pointer;"></canvas><div style="font-size: 0.7rem; text-align: center; color: #64748b; margin-top: 5px;">* Click columns for breakdown</div></div>
                <div style="margin-top:20px; border-top:1px solid #334; padding-top:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><h4 style="margin:0; color:var(--orange)">Real Daily Cost</h4><span style="font-size:0.7rem; color:#94a3b8;">Overhead: <span id="dispOverheadDay">...</span>/day</span></div>
                    <table class="cost-table"><thead><tr><th>Check</th><th>Name</th><th class="val-col">Real Cost/Day</th></tr></thead><tbody id="pricingBody"></tbody></table>
                    <div class="simulator-box" style="margin-top:10px; border:1px dashed #475569;">
                        <div style="font-size:0.7rem; color:#94a3b8; text-transform:uppercase;">Quick Proposal</div>
                        <input type="number" id="propDays" class="form-control" placeholder="Days" style="padding:5px; margin-bottom:5px;" oninput="runSim()">
                        <div style="display:flex; justify-content:space-between;"><span>Min Cost:</span><span id="propMin" style="color:var(--danger); font-weight:bold">$0</span></div>
                        <div style="display:flex; justify-content:space-between; margin-top:5px; align-items:center;">
                            <span style="line-height:1.1">Target Price<br><small style="color:#64748b; font-size:0.75rem;">(w/ <span id="propMarkupDisplay">0%</span> Mkp)</small></span><span id="propPrice" style="color:var(--success); font-weight:bold; font-size:1.2rem">$0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="smartPopover" style="display:none;">
    <div class="modal-content">
        <div class="pop-header"><div class="pop-title"><span id="popWeekName">WEEK X</span><h3 id="popDateRange">Provisioning Details</h3></div><span style="cursor:pointer; font-size:1.5rem; color:#94a3b8;" onclick="document.getElementById('smartPopover').style.display='none'">×</span></div>
        <div class="pop-body">
            <div class="big-number-box"><span style="color:#94a3b8; font-size:0.9rem;">Total to Provision</span><span id="popTotal" style="font-size:1.4rem; font-weight:bold; color:var(--success)">$0.00</span></div>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#cbd5e1;"><span>Payroll</span><span id="popPayrollVal">$0</span></div><div class="progress-bar-bg"><div id="popPayrollBar" class="progress-fill" style="background-color: var(--success); width: 0%;"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#cbd5e1;"><span>Overhead</span><span id="popOverheadVal">$0</span></div><div class="progress-bar-bg"><div id="popOverheadBar" class="progress-fill" style="background-color: var(--accent); width: 0%;"></div></div>
            <div style="border-top: 1px solid #334155; margin: 15px 0;"></div><ul id="popList" class="detail-list"></ul>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAXccSurpdFCwI8yBw6HX1DSEwZYdFX_Z0", authDomain: "allcablingtech-system.firebaseapp.com", projectId: "allcablingtech-system", storageBucket: "allcablingtech-system.firebasestorage.app", messagingSenderId: "395002580576", appId: "1:395002580576:web:877cb85f18a3c5f7b47d05" };
    let db; try { const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e) { console.error("FB Error", e); }

    let store = { employees: [], contractors: [], costs: [], settings: { profit: 100000, gross: 45, comm: 5 } };
    let chartInstance = null, pieChartInstance = null, weeklyDetailsStore = [];
    let currentUser = null;
    let authData = JSON.parse(localStorage.getItem('act_auth')) || { dante: '1996', leonardo: '1983' };
    let accessLogs = JSON.parse(localStorage.getItem('act_logs')) || [];

    window.attemptLogin = () => {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        if(authData[u] === p) {
            currentUser = u; document.getElementById('loginModal').style.display = 'none';
            document.body.classList.remove('view-only'); // Remove bloqueio total
            
            // SE FOR DANTE: MOSTRA ADMIN BUTTON
            if(u === 'dante') { document.querySelector('.admin-btn').style.display = 'inline-flex'; }
            
            accessLogs.unshift({ user: u, time: new Date().toLocaleString() });
            if(accessLogs.length > 50) accessLogs.pop();
            localStorage.setItem('act_logs', JSON.stringify(accessLogs)); renderLogs();
        } else { document.getElementById('loginError').style.display = 'block'; }
    };
    function renderLogs() { document.getElementById('logTable').innerHTML = accessLogs.map(l => `<tr><td>${l.time}</td><td style="color:${l.user==='dante'?'#3b82f6':'#f59e0b'}">${l.user.toUpperCase()}</td></tr>`).join(''); }
    window.updatePasswords = () => {
        const npL = document.getElementById('newPassLeo').value; const npD = document.getElementById('newPassDante').value;
        if(npL) authData.leonardo = npL; if(npD) authData.dante = npD;
        localStorage.setItem('act_auth', JSON.stringify(authData)); alert('Updated!'); document.getElementById('adminModal').style.display = 'none';
    };

    const syncHeights = () => { if(window.innerWidth <= 1200) return; const h = document.getElementById('panel3').offsetHeight; if(h > 400) { document.getElementById('panel1').style.height = h+'px'; document.getElementById('panel2').style.height = h+'px'; }};
    window.addEventListener('resize', syncHeights); setInterval(syncHeights, 1000);
    window.toggle = (id) => { const el = document.getElementById(id); el.style.display = el.style.display==='block'?'none':'block'; };

    // --- CRUD AGORA LIBERADO PARA DANTE E LEONARDO (AMBOS) ---
    const checkAuth = () => { return true; }; 

    window.saveEmployee = async () => { const id = document.getElementById('emp_id').value; const data = { name: document.getElementById('emp_name').value, state: document.getElementById('emp_state').value, net: Number(document.getElementById('emp_net').value)||0 }; if(id) await updateDoc(doc(db,'act_employees',id),data); else await addDoc(collection(db,'act_employees'),data); resetForms(); };
    window.saveContractor = async () => { const id = document.getElementById('cont_id').value; const data = { name: document.getElementById('cont_name').value, rate: Number(document.getElementById('cont_rate').value)||0, qty: Number(document.getElementById('cont_qty').value)||0, type: document.getElementById('cont_type').value, active: document.getElementById('cont_active').checked }; if(id) await updateDoc(doc(db,'act_contractors',id),data); else await addDoc(collection(db,'act_contractors'),data); resetForms(); };
    window.saveCost = async () => { const id = document.getElementById('cost_id').value; const data = { desc: document.getElementById('cost_desc').value, val: Number(document.getElementById('cost_val').value)||0, day: Number(document.getElementById('cost_day').value)||1 }; if(id) await updateDoc(doc(db,'act_costs',id),data); else await addDoc(collection(db,'act_costs'),data); resetForms(); };
    window.editItem = (type,id) => { 
        if(type==='emp'){ const i=store.employees.find(x=>x.id===id); document.getElementById('emp_id').value=i.id; document.getElementById('emp_name').value=i.name; document.getElementById('emp_net').value=i.net; document.getElementById('empForm').style.display='block'; }
        else if(type==='cont'){ const i=store.contractors.find(x=>x.id===id); document.getElementById('cont_id').value=i.id; document.getElementById('cont_name').value=i.name; document.getElementById('cont_rate').value=i.rate; document.getElementById('cont_qty').value=i.qty; document.getElementById('cont_active').checked=i.active; document.getElementById('contForm').style.display='block'; }
        else { const i=store.costs.find(x=>x.id===id); document.getElementById('cost_id').value=i.id; document.getElementById('cost_desc').value=i.desc; document.getElementById('cost_val').value=i.val; document.getElementById('cost_day').value=i.day; document.getElementById('costForm').style.display='block'; }
    };
    window.deleteItem = async (coll,id) => { if(confirm('Delete?')) await deleteDoc(doc(db,coll,id)); };
    
    window.runSim = () => { runCalculations(); setTimeout(syncHeights,100); };
    function resetForms() { document.querySelectorAll('input').forEach(i => { if(i.type!=='checkbox' && i.type!=='range') i.value=''; }); document.querySelectorAll('.form-container').forEach(d => d.style.display='none'); }

    if(db) {
        onSnapshot(doc(db,'act_settings','global'),s=>{if(s.exists()){store.settings=s.data();updateSliders();}});
        onSnapshot(collection(db,'act_employees'),s=>{store.employees=s.docs.map(d=>({id:d.id,...d.data()}));runSim();});
        onSnapshot(collection(db,'act_contractors'),s=>{store.contractors=s.docs.map(d=>({id:d.id,...d.data()}));runSim();});
        onSnapshot(collection(db,'act_costs'),s=>{store.costs=s.docs.map(d=>({id:d.id,...d.data()}));runSim();});
    }

    function updateSliders() { document.getElementById('slProfit').value=store.settings.profit; document.getElementById('slGross').value=store.settings.gross; document.getElementById('slComm').value=store.settings.comm; runCalculations(); }
    
    function runCalculations() {
        const checkedIDs = new Set(); document.querySelectorAll('.prop-check:checked').forEach(c => checkedIDs.add(c.dataset.id));
        let totalPayroll=0, headcount=0; weeklyDetailsStore=[{id:0,name:'W1 (1-7)',payroll:0,overhead:0,items:[]},{id:1,name:'W2 (8-15)',payroll:0,overhead:0,items:[]},{id:2,name:'W3 (16-23)',payroll:0,overhead:0,items:[]},{id:3,name:'W4 (24+)',payroll:0,overhead:0,items:[]}];
        
        const empHtml = store.employees.map(e => { const tr=e.state==='NY'?1.30:1.25; const tot=(e.net||0)*tr; totalPayroll+=tot; headcount++; return {...e,totalCost:tot,dailyBase:tot/20,type:'W2'}; });
        const contHtml = store.contractors.map(c => { const cost=(c.rate||0)*(c.qty||0); if(c.active){totalPayroll+=cost;headcount++;} return {...c,totalCost:cost,dailyBase:c.type==='hour'?(c.rate*8):c.rate,type:'1099'}; });
        
        let totalFixed=0, weeklyMap=[0,0,0,0], pieL=[], pieV=[];
        const costsHtml = store.costs.map(c => { 
            const val=c.val||0; totalFixed+=val; const d=c.day||1; let w=3; if(d<=7)w=0;else if(d<=15)w=1;else if(d<=23)w=2;
            weeklyMap[w]+=val; weeklyDetailsStore[w].overhead+=val; weeklyDetailsStore[w].items.push({desc:c.desc,val:val,cat:'Overhead',color:'#3b82f6'});
            pieL.push(c.desc); pieV.push(val); return {...c};
        });
        updatePieChart(pieL,pieV);

        const halfPay=totalPayroll/2; if(totalPayroll>0){ weeklyDetailsStore[0].payroll=halfPay;weeklyDetailsStore[0].items.push({desc:'Payroll 1',val:halfPay,cat:'Payroll',color:'#10b981'}); weeklyDetailsStore[1].payroll=halfPay;weeklyDetailsStore[1].items.push({desc:'Payroll 2',val:halfPay,cat:'Payroll',color:'#10b981'}); }
        weeklyDetailsStore.forEach(w => w.items.sort((a,b)=>b.val-a.val));

        document.getElementById('listEmp').innerHTML = empHtml.map(e => `<div class="list-card payroll"><div><b>${e.name}</b> <span style="font-size:0.7rem; border:1px solid #3b82f6; padding:0 2px; border-radius:3px; color:#3b82f6">W2</span><br><small>Net Salary: ${fmt(e.net)}</small></div><div><span class="card-val">${fmt(e.totalCost)}</span><button class="btn-icon" onclick="editItem('emp','${e.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-icon" onclick="deleteItem('act_employees','${e.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('');
        
        document.getElementById('listCont').innerHTML = contHtml.map(c => {
            const qty = c.qty || 0; const rate = c.rate || 0;
            return `<div class="list-card contractor" style="opacity:${c.active?1:0.5}"><div><b>${c.name}</b> <span style="font-size:0.7rem; border:1px solid #f97316; padding:0 2px; border-radius:3px; color:#f97316">1099</span><br><small>Qty: ${qty} (${c.type}) • Rate: ${fmt(rate)}</small></div><div><span class="card-val">${fmt(c.active?c.totalCost:0)}</span><button class="btn-icon" onclick="editItem('cont','${c.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-icon" onclick="deleteItem('act_contractors','${c.id}')"><i class="fas fa-trash"></i></button></div></div>`;
        }).join('');
        
        document.getElementById('listCost').innerHTML = costsHtml.map(c => `<div class="list-card expense"><div><span class="day-badge" style="background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; font-size:0.8em; margin-right:5px;">${c.day}</span> <b>${c.desc}</b></div><div><span class="card-val">${fmt(c.val)}</span><button class="btn-icon" onclick="editItem('cost','${c.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn-icon" onclick="deleteItem('act_costs','${c.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('');

        const totCapDays=headcount*20; const ovhdPerDay=totCapDays>0?totalFixed/totCapDays:0;
        let pRows=''; [...empHtml,...contHtml].forEach(p=>{
            if(p.type==='1099'&&!p.active)return; const rCost=p.dailyBase+ovhdPerDay; const chk=checkedIDs.has(p.id)?'checked':'';
            const bdg=p.type==='W2'?'<span style="font-size:0.7rem;border:1px solid #3b82f6;padding:0 2px;border-radius:3px;color:#3b82f6;margin-left:5px">W2</span>':'<span style="font-size:0.7rem;border:1px solid #f97316;padding:0 2px;border-radius:3px;color:#f97316;margin-left:5px">1099</span>';
            pRows+=`<tr><td style="text-align:center"><input type="checkbox" class="prop-check" data-id="${p.id}" data-cost="${rCost}" ${chk} onchange="runSim()"></td><td>${p.name}${bdg}<div style="font-size:0.7rem;color:#64748b;margin-top:2px;">Base: ${fmt(p.dailyBase)} + Ovhd: ${fmt(ovhdPerDay)}</div></td><td class="val-col">${fmt(rCost)}</td></tr>`;
        });
        document.getElementById('pricingBody').innerHTML=pRows;

        const goal=Number(document.getElementById('slProfit').value); const marg=Number(document.getElementById('slGross').value); const comm=Number(document.getElementById('slComm').value);
        document.getElementById('lblProfit').innerText=fmt(goal)+'/yr'; document.getElementById('lblGross').innerText=marg+'%'; document.getElementById('lblComm').innerText=comm+'%';
        const totOut=totalPayroll+totalFixed; const tgtMon=goal/12; const mgDec=(marg-comm)/100; let rev=0; if(mgDec>0.05) rev=(totOut+tgtMon)/mgDec;
        
        document.getElementById('dispPayroll').innerText=fmt(totalPayroll); document.getElementById('dispFixed').innerText=fmt(totalFixed);
        document.getElementById('kpiTotal').innerText=fmt(totOut); document.getElementById('kpiBreak').innerText=fmt(mgDec>0?totOut/mgDec:0); document.getElementById('kpiProfit').innerText=fmt(tgtMon);
        document.getElementById('valRevenue').innerText=fmt(rev); document.getElementById('valFixed').innerText=fmt(totOut); document.getElementById('valCOGS').innerText=fmt(rev*(1-(marg/100)));
        document.getElementById('dispOverheadDay').innerText=fmt(ovhdPerDay);
        
        const pDays=Number(document.getElementById('propDays').value)||1; let dSum=0; document.querySelectorAll('.prop-check:checked').forEach(c=>dSum+=Number(c.dataset.cost));
        const minC=dSum*pDays; const sugg=minC/(1-(marg/100));
        document.getElementById('propMin').innerText=fmt(minC); document.getElementById('propPrice').innerText=fmt(sugg); document.getElementById('propMarkupDisplay').innerText=marg+'%';

        // --- CHART UPDATE FOR MULTI-LINE LABELS ---
        const chartLabels = weeklyDetailsStore.map(d => [d.name, fmt(d.payroll + d.overhead)]); 

        if(chartInstance)chartInstance.destroy(); const ctx=document.getElementById('cashChart').getContext('2d');
        chartInstance=new Chart(ctx,{type:'bar',data:{labels:chartLabels,datasets:[{label:'Payroll',data:[halfPay,halfPay,0,0],backgroundColor:'#10b981',stack:'0'},{label:'Overhead',data:weeklyMap,backgroundColor:'#3b82f6',stack:'0'}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}},onClick:(e,el)=>{if(el.length>0)renderWeekDetails(el[0].index);}}});
        setTimeout(syncHeights,200);
    }

    function updatePieChart(l,v) {
        if(pieChartInstance)pieChartInstance.destroy(); const ctx=document.getElementById('overheadChart').getContext('2d');
        pieChartInstance=new Chart(ctx,{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#f97316'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{enabled:true}},cutout:'70%'}});
    }

    function renderWeekDetails(i) {
        const d=weeklyDetailsStore[i]; const t=d.payroll+d.overhead;
        document.getElementById('popWeekName').innerText=d.name; document.getElementById('popTotal').innerText=fmt(t);
        document.getElementById('popPayrollVal').innerText=fmt(d.payroll); document.getElementById('popOverheadVal').innerText=fmt(d.overhead);
        document.getElementById('popPayrollBar').style.width=(t>0?(d.payroll/t)*100:0)+'%'; document.getElementById('popOverheadBar').style.width=(t>0?(d.overhead/t)*100:0)+'%';
        const l=document.getElementById('popList');
        if(d.items.length===0)l.innerHTML='<li class="detail-item" style="color:#64748b;font-style:italic">No items.</li>';
        else l.innerHTML=d.items.map(i=>`<li class="detail-item"><div style="display:flex;align-items:center;"><span class="cat-badge" style="background:${i.color}20;color:${i.color}">${i.cat.substring(0,3)}</span><span>${i.desc}</span></div><span style="font-family:monospace;color:#e2e8f0;">${fmt(i.val)}</span></li>`).join('');
        document.getElementById('smartPopover').style.display='flex';
    }
    function fmt(n){return '$'+(n||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});} document.getElementById('dateDisplay').innerText=new Date().toDateString();
</script>
</body>
</html>