<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Executivo v4 | All Cabling Tech (Online)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a; --panel-dark: #1e293b; --accent: #3b82f6; 
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; 
            --purple: #8b5cf6; --cogs: #64748b;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* HEADER */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 20px;
        }
        .logo-container { text-align: right; }
        .logo-img { height: 65px; display: block; margin-left: auto; }
        .logo-text { 
            font-size: 1.8rem; font-weight: 800; color: var(--text-main); 
            text-transform: uppercase; letter-spacing: 1px; display: none; 
            background: linear-gradient(90deg, #3b82f6, #10b981);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .report-info h1 { font-size: 1.2rem; margin: 0; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .report-info span { font-size: 0.9rem; color: #64748b; }

        /* GRID LAYOUT */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 20px; }
        @media(max-width: 1200px) { .main-grid { grid-template-columns: 1fr 1fr; } .right-col { grid-column: span 2; } }
        @media(max-width: 800px) { .main-grid { grid-template-columns: 1fr; } .right-col { grid-column: span 1; } }

        /* PANELS */
        .panel { background: var(--panel-dark); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); margin-bottom: 20px; height: 100%; display: flex; flex-direction: column; }
        .panel-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: var(--accent); border-bottom: 1px solid #334155; padding-bottom: 10px; }
        
        /* INPUTS & FORMS */
        .form-container { background: #334155; padding: 15px; border-radius: 8px; margin-bottom: 15px; transition: 0.3s; border: 1px solid transparent; }
        .form-container.editing { border-color: var(--warning); background: #334155; box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); }
        
        .form-group { margin-bottom: 15px; }
        .form-control { 
            width: 100%; background: #1e293b; border: 1px solid #475569; color: white; 
            padding: 10px; border-radius: 6px; font-size: 0.95rem; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--accent); outline: none; }
        .row-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* BUTTONS */
        .btn { border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #0f172a; } 
        .btn-cancel { background: #64748b; color: white; width: auto; flex: 1; }
        .btn-save { flex: 2; }
        
        .btn-icon { background: transparent; color: var(--text-muted); width: auto; padding: 5px; font-size: 1rem; border-radius: 4px; cursor: pointer; border: none; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: white; }
        .btn-edit-icon { color: var(--warning); }
        .btn-del-icon { color: var(--danger); }

        /* LISTS */
        .scroll-list { max-height: 400px; overflow-y: auto; padding-right: 5px; flex-grow: 1; }
        
        /* CARDS */
        .list-card { 
            background: #334155; border-radius: 8px; padding: 12px; margin-bottom: 8px; 
            border-left: 4px solid var(--text-muted); display: flex; justify-content: space-between; align-items: center;
        }
        .list-card.expense { border-left-color: var(--warning); }
        .list-card.payroll { border-left-color: var(--accent); cursor: pointer; }
        .list-card:hover { background: #3b82f620; }
        .card-info { flex-grow: 1; }
        .card-title { font-weight: bold; font-size: 0.95rem; color: white; }
        .card-sub { font-size: 0.8rem; color: var(--text-muted); }
        .card-val { font-family: monospace; font-weight: bold; color: var(--success); text-align: right; margin-right: 15px; }

        /* FINANCIAL DASHBOARD */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: #334155; padding: 10px; border-radius: 8px; text-align: center; border-bottom: 3px solid transparent; }
        .kpi-val { font-size: 1.1rem; font-weight: 800; margin: 5px 0; font-family: 'Consolas', monospace; }
        .kpi-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        
        /* SIMULATOR */
        .simulator-box { background: #1e293b; border: 1px solid #334155; padding: 15px; border-radius: 12px; }
        .slider-group { margin-bottom: 15px; }
        .sim-slider { width: 100%; margin: 8px 0; cursor: pointer; appearance: none; height: 6px; border-radius: 3px; background: #475569; }
        .sim-slider::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 50%; background: white; cursor: pointer; transition:0.2s; }
        .sim-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

        #profitSlider::-webkit-slider-thumb { background: var(--success); }
        #grossSlider::-webkit-slider-thumb { background: var(--accent); }
        #commSlider::-webkit-slider-thumb { background: var(--purple); }

        .slider-label { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; }

        .projection-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .projection-table td { padding: 6px 8px; border-bottom: 1px solid #334155; }
        .projection-table .val { text-align: right; font-family: monospace; font-weight: bold; }
        .row-highlight { color: var(--success); font-size: 1.1rem; background: rgba(16, 185, 129, 0.1); }
        .row-total { color: var(--accent); font-size: 1.2rem; border-top: 2px solid #475569; font-weight: 800; }
        .row-breakeven { font-size: 0.8rem; color: var(--text-muted); font-style: italic; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--panel-dark); width: 90%; max-width: 600px; border-radius: 12px; padding: 30px; border: 1px solid var(--accent); }
        .close-modal { float: right; font-size: 1.5rem; cursor: pointer; }

        /* LOADING INDICATOR */
        #loadingBar { position:fixed; top:0; left:0; width:0%; height:4px; background:var(--accent); z-index:2000; transition:width 0.3s; }

        /* REPORT TABLE (Hidden normally, shown in print) */
        .report-only { display: none; }

        @media print {
            body { background: white; color: black; font-size: 12px; padding: 0; }
            .container { max-width: 100%; margin: 0; }
            .header { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #000; }
            .logo-text { display: block !important; color: #000; -webkit-text-fill-color: black; }
            .logo-img { display: block !important; }
            .no-print, button, .sim-slider, .form-container, .scroll-list, .list-card button { display: none !important; }
            .report-only { display: block; margin-top: 20px; }
            .main-grid { display: block; }
            .left-col, .mid-col { display: none; } 
            .right-col { width: 100%; }
            .panel { box-shadow: none; border: none; padding: 0; margin: 0; }
            .panel-title { display: none; }
            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .kpi-card { border: 1px solid #ddd; background: #f9f9f9; color: black; }
            .kpi-val { color: black; }
            .simulator-box { border: 1px solid #ddd; background: white; padding: 0; }
            .projection-table td { border-bottom: 1px solid #ddd; color: black; }
            .full-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }
            .full-table th { background: #eee; text-align: left; padding: 5px; border: 1px solid #ccc; color:black; }
            .full-table td { border: 1px solid #ccc; padding: 5px; color:black; }
            canvas { max-height: 250px !important; }
        }
    </style>
</head>
<body>

<div id="loadingBar"></div>

<div class="container">
    <header class="header">
        <div class="report-info">
            <h1>Relatório Executivo | Overhead Report</h1>
            <span><i class="fas fa-cloud"></i> Sistema Online & Sincronizado</span>
        </div>
        
        <div class="logo-container">
            <img src="https://lh3.googleusercontent.com/d/1Zlo-Cf7zY-jANUusmo5iwCR8ADbPu6wx" 
                 alt="ACT Logo" 
                 class="logo-img"
                 onerror="this.style.display='none'; document.getElementById('txtLogo').style.display='block';">
            <div id="txtLogo" class="logo-text">ALL CABLING TECH</div>
        </div>
    </header>

    <div class="main-grid">
        
        <div class="left-col">
            <div class="panel">
                <div class="panel-title"><i class="fas fa-users"></i> 1. Gestão de Equipe</div>
                
                <div id="empFormBox" class="form-container no-print">
                    <input type="hidden" id="emp_edit_id">
                    <input type="text" id="emp_name" class="form-control" placeholder="Nome do Funcionário" style="margin-bottom: 10px;">
                    <div class="row-inputs">
                        <select id="emp_state" class="form-control">
                            <option value="FL">FL (0% State Tax)</option>
                            <option value="NY">NY (~5% State Tax)</option>
                        </select>
                        <select id="emp_filing" class="form-control">
                            <option value="joint">Married (Joint)</option>
                            <option value="single">Single</option>
                        </select>
                    </div>
                    <div class="row-inputs" style="margin-top: 10px;">
                        <input type="number" id="emp_net" class="form-control" placeholder="Salário Líquido (Net)">
                        <input type="number" id="emp_deps" class="form-control" value="0" placeholder="Dependentes">
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top: 10px;">
                        <button id="btnCancelEmp" onclick="cancelEmpEdit()" class="btn btn-cancel" style="display:none;">Cancelar</button>
                        <button id="btnSaveEmp" type="button" onclick="saveEmployee()" class="btn btn-primary btn-save">+ Adicionar</button>
                    </div>
                </div>

                <div id="employeeList" class="scroll-list">
                    <p style="color:#64748b; text-align:center; padding:20px;">Carregando dados...</p>
                </div>
                <div style="margin-top:auto; padding-top:10px; text-align:right; font-weight:bold; color:var(--accent); border-top:1px solid #334155;">
                    Total Payroll (Mês): <span id="totalPayrollDisplay">...</span>
                </div>
            </div>
        </div>

        <div class="mid-col">
            <div class="panel">
                <div class="panel-title"><i class="fas fa-building"></i> 2. Custos Fixos (Overhead)</div>
                
                <div id="costFormBox" class="form-container no-print">
                    <input type="hidden" id="cost_edit_id">
                    <p style="font-size:0.8rem; color:#94a3b8; margin-top:0;">Aluguel, Seguros, Softwares, Veículos...</p>
                    <div class="row-inputs">
                        <input type="text" id="cost_desc" class="form-control" placeholder="Descrição">
                        <input type="number" id="cost_val" class="form-control" placeholder="Valor Mensal $">
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top: 10px;">
                        <button id="btnCancelCost" onclick="cancelCostEdit()" class="btn btn-cancel" style="display:none;">Cancelar</button>
                        <button id="btnSaveCost" type="button" onclick="saveFixedCost()" class="btn btn-success btn-save">+ Lançar Custo</button>
                    </div>
                </div>

                <div id="fixedCostList" class="scroll-list">
                    <p style="color:#64748b; text-align:center; padding:20px;">Carregando dados...</p>
                </div>
                <div style="margin-top:auto; padding-top:10px; text-align:right; font-weight:bold; color:var(--warning); border-top:1px solid #334155;">
                    Total Overhead (Mês): <span id="totalFixedDisplay">...</span>
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="panel">
                <div class="panel-title"><i class="fas fa-chart-line"></i> 3. Simulador & Metas</div>

                <div class="print-grid">
                    <div class="kpi-row">
                        <div class="kpi-card" style="border-bottom-color: var(--danger);">
                            <div class="kpi-label">Custo Fixo Total</div>
                            <div class="kpi-val" id="totalOutflow">$0</div>
                        </div>
                        <div class="kpi-card" style="border-bottom-color: var(--cogs);">
                            <div class="kpi-label">Ponto Equilíbrio</div>
                            <div class="kpi-val" id="breakevenVal">$0</div>
                        </div>
                        <div class="kpi-card" style="border-bottom-color: var(--success);">
                            <div class="kpi-label">Lucro Mensal Alvo</div>
                            <div class="kpi-val" id="targetProfitMonthly">$0</div>
                        </div>
                    </div>

                    <div class="simulator-box">
                        <div class="no-print">
                            <div class="slider-group">
                                <label class="slider-label" style="color:var(--success);">
                                    <span>Meta Lucro Anual (Dono)</span> <span id="profitDisplay">$100k</span>
                                </label>
                                <input type="range" id="profitSlider" class="sim-slider" min="0" max="500000" step="5000" value="100000" oninput="updateSimulation()">
                            </div>

                            <div class="slider-group">
                                <label class="slider-label" style="color:var(--accent);">
                                    <span>Margem Bruta Venda (Markup)</span> <span id="grossDisplay">50%</span>
                                </label>
                                <input type="range" id="grossSlider" class="sim-slider" min="10" max="90" value="50" oninput="updateSimulation()">
                            </div>
                            
                            <div class="slider-group">
                                <label class="slider-label" style="color:var(--purple);">
                                    <span>Comissão Vendas</span> <span id="commDisplay">5%</span>
                                </label>
                                <input type="range" id="commSlider" class="sim-slider" min="0" max="20" value="5" oninput="updateSimulation()">
                            </div>
                        </div>
                        
                        <table class="projection-table">
                            <tr>
                                <td><i class="fas fa-arrow-down" style="color:var(--danger)"></i> Custos Fixos (Payroll+Overhead)</td>
                                <td class="val" id="simFixed">$0</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-arrow-up" style="color:var(--success)"></i> Meta Lucro Mensal</td>
                                <td class="val row-highlight" id="simProfit">$0</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-box" style="color:var(--cogs)"></i> Custo Materiais (COGS)</td>
                                <td class="val" style="color:var(--cogs)" id="simCOGS">$0</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-user-tag" style="color:var(--purple)"></i> Comissões (<span id="commPctText">5%</span>)</td>
                                <td class="val" style="color:var(--purple)" id="simComm">$0</td>
                            </tr>
                            <tr style="border-top: 2px solid #475569; background:#0f172a;">
                                <td style="padding:12px; font-weight:bold; color:white;">FATURAMENTO NECESSÁRIO</td>
                                <td class="val row-total" style="padding:12px;" id="simRevenue">$0</td>
                            </tr>
                            <tr>
                                <td colspan="2" class="row-breakeven" align="center">
                                    Para pagar contas (Lucro $0), fature: <span id="beSmall">$0</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div style="height:220px; margin-top:20px; page-break-inside: avoid;">
                    <canvas id="structureChart"></canvas>
                </div>

                <div class="report-only">
                    <h3>Detalhamento da Folha de Pagamento (Payroll Breakdown)</h3>
                    <table class="full-table">
                        <thead>
                            <tr>
                                <th>Funcionário</th>
                                <th>Estado/Status</th>
                                <th>Líquido (Net)</th>
                                <th>Impostos (Func)</th>
                                <th>Bruto (Gross)</th>
                                <th>Custo Patronal</th>
                                <th>Custo Total</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                    
                    <h3 style="margin-top:20px;">Detalhamento de Custos Fixos (Overhead)</h3>
                    <table class="full-table">
                        <thead>
                            <tr>
                                <th>Descrição do Custo</th>
                                <th style="text-align:right;">Valor</th>
                            </tr>
                        </thead>
                        <tbody id="reportCostsBody"></tbody>
                    </table>
                    
                    <div style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">
                        <strong>Parâmetros da Simulação:</strong><br>
                        Meta Anual Lucro: <span id="printProfit"></span> | Margem Bruta (Markup): <span id="printGross"></span> | Comissão: <span id="printComm"></span>
                    </div>
                </div>
                
                <button onclick="window.print()" class="btn btn-primary no-print" style="margin-top:20px;">
                    <i class="fas fa-print"></i> Imprimir Relatório Executivo
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="empModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">×</span>
        <h3 id="modalName">Detalhes</h3>
        <table class="projection-table" style="font-size:1.1rem;">
            <tr><td>Líquido (No Bolso)</td><td class="val" id="modalNet" style="color:var(--success)">$0</td></tr>
            <tr><td>Taxas (Retido Func.)</td><td class="val" id="modalTaxEmp" style="color:#ef4444">$0</td></tr>
            <tr style="border-top:1px dashed #666"><td><strong>Salário Bruto</strong></td><td class="val" id="modalGross">$0</td></tr>
            <tr><td>Taxas (Empresa)</td><td class="val" id="modalTaxComp">$0</td></tr>
            <tr style="background:#1e293b; border-top:2px solid var(--accent)">
                <td style="padding:15px"><strong>Custo Total Empresa</strong></td>
                <td class="val" id="modalTotal" style="padding:15px; color:var(--accent)">$0</td>
            </tr>
        </table>
        <div style="height:150px; margin-top:20px;">
            <canvas id="empChart"></canvas>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAXccSurpdFCwI8yBw6HX1DSEwZYdFX_Z0",
      authDomain: "allcablingtech-system.firebaseapp.com",
      projectId: "allcablingtech-system",
      storageBucket: "allcablingtech-system.firebasestorage.app",
      messagingSenderId: "395002580576",
      appId: "1:395002580576:web:877cb85f18a3c5f7b47d05"
    };

    // Initialize Firebase
    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("Firebase Connected");
    } catch(e) {
        console.error("Firebase Config Missing or Error", e);
        alert("Attention: Firebase configuration error.");
    }

    // --- GLOBAL VARIABLES & STATE ---
    let employees = [];
    let fixedCosts = [];
    let mainChart = null;
    let modalChart = null;

    // --- EXPOSE FUNCTIONS TO WINDOW (Because type="module" isolates scope) ---
    window.saveEmployee = saveEmployee;
    window.editEmp = editEmp;
    window.cancelEmpEdit = cancelEmpEdit;
    window.removeEmp = removeEmp;
    window.saveFixedCost = saveFixedCost;
    window.editCost = editCost;
    window.cancelCostEdit = cancelCostEdit;
    window.removeCost = removeCost;
    window.updateSimulation = () => updateSimulation(); // wrapper
    window.openModal = openModal;
    window.closeModal = closeModal;

    // --- REALTIME LISTENERS ---
    if(db) {
        // Listen for Employees
        onSnapshot(collection(db, "act_employees"), (snapshot) => {
            employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
            document.getElementById('loadingBar').style.width = "50%";
        });

        // Listen for Costs
        onSnapshot(collection(db, "act_costs"), (snapshot) => {
            fixedCosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
            document.getElementById('loadingBar').style.width = "100%";
            setTimeout(() => document.getElementById('loadingBar').style.width = "0%", 500);
        });
    }

    // --- LOGIC: PAYROLL ---
    function calculatePayroll(net, state, filing, deps) {
        let effectiveRate = (filing === 'joint') ? 0.08 : 0.14; 
        effectiveRate -= (deps * 0.015);
        if (effectiveRate < 0.02) effectiveRate = 0.02; 
        if (state === 'NY') effectiveRate += 0.045; 
        
        const ficaRate = 0.0765; 
        const gross = net / (1 - (effectiveRate + ficaRate));
        const employerFica = gross * 0.0765; 
        const futa_suta = gross * 0.008; 
        const totalCost = gross + employerFica + futa_suta;

        return { net, gross, empTax: gross * (effectiveRate + ficaRate), compTax: employerFica + futa_suta, totalCost };
    }

    // --- CRUD EMPLOYEES ---
    async function saveEmployee() {
        const id = document.getElementById('emp_edit_id').value;
        const name = document.getElementById('emp_name').value;
        const net = parseFloat(document.getElementById('emp_net').value);
        
        if(!name || isNaN(net)) return alert('Preencha nome e valor líquido');

        const data = {
            name,
            state: document.getElementById('emp_state').value,
            filing: document.getElementById('emp_filing').value,
            net,
            deps: parseInt(document.getElementById('emp_deps').value) || 0
        };

        if(id) {
            await updateDoc(doc(db, "act_employees", id), data);
            cancelEmpEdit();
        } else {
            await addDoc(collection(db, "act_employees"), data);
        }
        clearEmpForm();
    }

    function editEmp(id) {
        const emp = employees.find(e => e.id === id);
        if(!emp) return;
        document.getElementById('emp_edit_id').value = emp.id;
        document.getElementById('emp_name').value = emp.name;
        document.getElementById('emp_state').value = emp.state;
        document.getElementById('emp_filing').value = emp.filing;
        document.getElementById('emp_net').value = emp.net;
        document.getElementById('emp_deps').value = emp.deps;
        
        document.getElementById('empFormBox').classList.add('editing');
        document.getElementById('btnSaveEmp').innerText = "Salvar Alteração";
        document.getElementById('btnSaveEmp').className = "btn btn-warning btn-save";
        document.getElementById('btnCancelEmp').style.display = "block";
    }

    function cancelEmpEdit() {
        clearEmpForm();
        document.getElementById('emp_edit_id').value = "";
        document.getElementById('empFormBox').classList.remove('editing');
        document.getElementById('btnSaveEmp').innerText = "+ Adicionar";
        document.getElementById('btnSaveEmp').className = "btn btn-primary btn-save";
        document.getElementById('btnCancelEmp').style.display = "none";
    }

    async function removeEmp(id) {
        if(confirm("Remover funcionário?")) {
            await deleteDoc(doc(db, "act_employees", id));
        }
    }

    function clearEmpForm() {
        document.getElementById('emp_name').value = '';
        document.getElementById('emp_net').value = '';
        document.getElementById('emp_deps').value = '0';
    }

    // --- CRUD FIXED COSTS ---
    async function saveFixedCost() {
        const id = document.getElementById('cost_edit_id').value;
        const desc = document.getElementById('cost_desc').value;
        const val = parseFloat(document.getElementById('cost_val').value);
        
        if(!desc || isNaN(val)) return alert('Preencha descrição e valor');

        const data = { desc, val };

        if(id) {
            await updateDoc(doc(db, "act_costs", id), data);
            cancelCostEdit();
        } else {
            await addDoc(collection(db, "act_costs"), data);
        }
        clearCostForm();
    }

    function editCost(id) {
        const cost = fixedCosts.find(c => c.id === id);
        if(!cost) return;
        document.getElementById('cost_edit_id').value = cost.id;
        document.getElementById('cost_desc').value = cost.desc;
        document.getElementById('cost_val').value = cost.val;
        
        document.getElementById('costFormBox').classList.add('editing');
        document.getElementById('btnSaveCost').innerText = "Salvar Alteração";
        document.getElementById('btnSaveCost').className = "btn btn-warning btn-save";
        document.getElementById('btnCancelCost').style.display = "block";
    }

    function cancelCostEdit() {
        clearCostForm();
        document.getElementById('cost_edit_id').value = "";
        document.getElementById('costFormBox').classList.remove('editing');
        document.getElementById('btnSaveCost').innerText = "+ Lançar Custo";
        document.getElementById('btnSaveCost').className = "btn btn-success btn-save";
        document.getElementById('btnCancelCost').style.display = "none";
    }

    async function removeCost(id) {
        if(confirm("Remover custo?")) {
            await deleteDoc(doc(db, "act_costs", id));
        }
    }

    function clearCostForm() {
        document.getElementById('cost_desc').value = '';
        document.getElementById('cost_val').value = '';
    }

    // --- RENDER & SIMULATION ---
    function renderAll() {
        const empList = document.getElementById('employeeList');
        const reportBody = document.getElementById('reportTableBody');
        empList.innerHTML = '';
        reportBody.innerHTML = '';
        let totalPayroll = 0;

        employees.forEach(e => {
            const f = calculatePayroll(e.net, e.state, e.filing, e.deps);
            totalPayroll += f.totalCost;

            empList.innerHTML += `
                <div class="list-card payroll">
                    <div class="card-info" onclick="openModal('${e.id}')">
                        <div class="card-title">${e.name}</div>
                        <div class="card-sub">Net: ${formatMoney(e.net)} | Cost: ${formatMoney(f.totalCost)}</div>
                    </div>
                    <div>
                        <button class="btn-icon btn-edit-icon" onclick="editEmp('${e.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn-icon btn-del-icon" onclick="removeEmp('${e.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;

            reportBody.innerHTML += `
                <tr><td>${e.name}</td><td>${e.state} / ${e.filing}</td>
                    <td>${formatMoney(f.net)}</td><td>${formatMoney(f.empTax)}</td>
                    <td>${formatMoney(f.gross)}</td><td>${formatMoney(f.compTax)}</td>
                    <td><strong>${formatMoney(f.totalCost)}</strong></td></tr>`;
        });
        document.getElementById('totalPayrollDisplay').innerText = formatMoney(totalPayroll);

        const costList = document.getElementById('fixedCostList');
        const reportCosts = document.getElementById('reportCostsBody');
        costList.innerHTML = '';
        reportCosts.innerHTML = '';
        let totalFixed = 0;

        fixedCosts.forEach(c => {
            totalFixed += c.val;
            costList.innerHTML += `
                <div class="list-card expense">
                    <div class="card-info"><div class="card-title">${c.desc}</div></div>
                    <div class="card-val">${formatMoney(c.val)}</div>
                    <div>
                        <button class="btn-icon btn-edit-icon" onclick="editCost('${c.id}')"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn-icon btn-del-icon" onclick="removeCost('${c.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            reportCosts.innerHTML += `<tr><td>${c.desc}</td><td style="text-align:right;">${formatMoney(c.val)}</td></tr>`;
        });
        document.getElementById('totalFixedDisplay').innerText = formatMoney(totalFixed);

        updateSimulation(totalPayroll, totalFixed);
    }

    function updateSimulation(payroll = null, fixed = null) {
        if(payroll === null) payroll = parseFloat(document.getElementById('totalPayrollDisplay').innerText.replace('$','').replace(',','')) || 0;
        if(fixed === null) fixed = parseFloat(document.getElementById('totalFixedDisplay').innerText.replace('$','').replace(',','')) || 0;

        const targetAnnualProfit = parseInt(document.getElementById('profitSlider').value);
        const grossMargin = parseInt(document.getElementById('grossSlider').value);
        const commPct = parseInt(document.getElementById('commSlider').value);
        
        document.getElementById('profitDisplay').innerText = '$' + (targetAnnualProfit/1000).toFixed(0) + 'k/ano';
        document.getElementById('grossDisplay').innerText = grossMargin + '%';
        document.getElementById('commDisplay').innerText = commPct + '%';
        
        document.getElementById('printProfit').innerText = formatMoney(targetAnnualProfit);
        document.getElementById('printGross').innerText = grossMargin + '%';
        document.getElementById('printComm').innerText = commPct + '%';
        document.getElementById('commPctText').innerText = commPct + '%';

        const totalFixedMonthly = payroll + fixed;
        const targetMonthlyProfit = targetAnnualProfit / 12;
        const denominator = (grossMargin / 100) - (commPct / 100);
        
        let revenue = 0, cogsVal = 0, commVal = 0, breakEvenRevenue = 0;

        if(denominator > 0) {
            revenue = (totalFixedMonthly + targetMonthlyProfit) / denominator;
            breakEvenRevenue = totalFixedMonthly / denominator;
        }

        cogsVal = revenue * (1 - (grossMargin/100));
        commVal = revenue * (commPct/100);

        document.getElementById('simFixed').innerText = formatMoney(totalFixedMonthly);
        document.getElementById('simProfit').innerText = formatMoney(targetMonthlyProfit);
        document.getElementById('simCOGS').innerText = formatMoney(cogsVal);
        document.getElementById('simComm').innerText = formatMoney(commVal);
        document.getElementById('simRevenue').innerText = formatMoney(revenue);
        
        document.getElementById('totalOutflow').innerText = formatMoney(totalFixedMonthly);
        document.getElementById('breakevenVal').innerText = formatMoney(breakEvenRevenue);
        document.getElementById('beSmall').innerText = formatMoney(breakEvenRevenue);
        document.getElementById('targetProfitMonthly').innerText = formatMoney(targetMonthlyProfit);

        updateChart(cogsVal, commVal, totalFixedMonthly, targetMonthlyProfit);
    }

    function updateChart(cogs, comm, fixed, profit) {
        const ctx = document.getElementById('structureChart').getContext('2d');
        if(mainChart) mainChart.destroy();
        mainChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Materiais (COGS)', 'Comissões', 'Custos Fixos', 'Lucro Líquido'],
                datasets: [{ 
                    data: [cogs, comm, fixed, profit], 
                    backgroundColor: ['#64748b', '#8b5cf6', '#ef4444', '#10b981'], 
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position:'bottom' } } }
        });
    }

    function formatMoney(n) { 
        return '$' + (n || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); 
    }

    function openModal(id) {
        const emp = employees.find(e => e.id === id);
        const f = calculatePayroll(emp.net, emp.state, emp.filing, emp.deps);
        document.getElementById('modalName').innerText = emp.name;
        document.getElementById('modalNet').innerText = formatMoney(f.net);
        document.getElementById('modalTaxEmp').innerText = formatMoney(f.empTax);
        document.getElementById('modalGross').innerText = formatMoney(f.gross);
        document.getElementById('modalTaxComp').innerText = formatMoney(f.compTax);
        document.getElementById('modalTotal').innerText = formatMoney(f.totalCost);
        document.getElementById('empModal').style.display = 'flex';

        const ctx = document.getElementById('empChart').getContext('2d');
        if(modalChart) modalChart.destroy();
        modalChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Net', 'Taxas', 'Custo Total'],
                datasets: [{ data: [f.net, f.empTax+f.compTax, f.totalCost], backgroundColor: ['#10b981', '#f59e0b', '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }
    
    function closeModal() { document.getElementById('empModal').style.display = 'none'; }
</script>
</body>
</html>